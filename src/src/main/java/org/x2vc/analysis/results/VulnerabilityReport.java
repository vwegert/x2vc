package org.x2vc.analysis.results;

import java.net.URI;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;

import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.adapters.XmlJavaTypeAdapter;

import org.x2vc.utilities.LocalDateTimeAdapter;

import com.google.common.base.Supplier;
import com.google.common.base.Suppliers;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.Lists;

/**
 * Standard implementation of {@link IVulnerabilityReport}.
 */
@XmlRootElement(name = "vulnerabilityReport")
public class VulnerabilityReport implements IVulnerabilityReport {

	private URI stylesheetURI;
	private LocalDateTime checkDate;
	private ImmutableList<IVulnerabilityReportSection> sections;

	VulnerabilityReport() {
		// default constructor to make JAXB happy
	}

	@Override
	@XmlAttribute(name = "stylesheetURI")
	public URI getStylesheetURI() {
		return this.stylesheetURI;
	}

	@Override
	@XmlAttribute(name = "checkDate")
	@XmlJavaTypeAdapter(LocalDateTimeAdapter.class)
	public LocalDateTime getCheckDate() {
		return this.checkDate;
	}

	@SuppressWarnings("java:S4738") // Java supplier does not support memoization
	private Supplier<Integer> issueNumberSupplier = Suppliers
		.memoize(() -> this.sections.stream().mapToInt(s -> s.getIssues().size()).sum());

	private VulnerabilityReport(Builder builder) {
		this.stylesheetURI = builder.stylesheetURI;
		this.checkDate = builder.checkDate;
		this.sections = ImmutableList.copyOf(builder.sections);
	}

	@Override
	@XmlAttribute(name = "totalIssues")
	public Integer getTotalNumberOfIssues() {
		return this.issueNumberSupplier.get();
	}

	@Override
	@XmlElementWrapper(name = "sections")
	@XmlElement(name = "section", type = VulnerabilityReportSection.class)
	public ImmutableList<IVulnerabilityReportSection> getSections() {
		return this.sections;
	}

	@Override
	public int hashCode() {
		return Objects.hash(this.checkDate, this.sections, this.stylesheetURI);
	}

	@Override
	public boolean equals(Object obj) {
		if (this == obj) {
			return true;
		}
		if (obj == null) {
			return false;
		}
		if (getClass() != obj.getClass()) {
			return false;
		}
		final VulnerabilityReport other = (VulnerabilityReport) obj;
		return Objects.equals(this.checkDate, other.checkDate) && Objects.equals(this.sections, other.sections)
				&& Objects.equals(this.stylesheetURI, other.stylesheetURI);
	}

	/**
	 * Provides a builder to create a report instance.
	 *
	 * @param stylesheetURI
	 * @return a new builder
	 */
	public static Builder builder(URI stylesheetURI) {
		return new Builder(stylesheetURI);
	}

	/**
	 * Builder to build {@link VulnerabilityReport}.
	 */
	public static final class Builder {
		private URI stylesheetURI;
		private LocalDateTime checkDate = LocalDateTime.now();
		private List<IVulnerabilityReportSection> sections = Lists.newArrayList();

		private Builder(URI stylesheetURI) {
			this.stylesheetURI = stylesheetURI;
		}

		/**
		 * Builder method for checkDate parameter.
		 *
		 * @param checkDate field to set
		 * @return builder
		 */
		public Builder withCheckDate(LocalDateTime checkDate) {
			this.checkDate = checkDate;
			return this;
		}

		/**
		 * Builder method for sections parameter.
		 *
		 * @param section field to set
		 * @return builder
		 */
		public Builder addSection(IVulnerabilityReportSection section) {
			this.sections.add(section);
			return this;
		}

		/**
		 * Builder method for sections parameter.
		 *
		 * @param sections field to set
		 * @return builder
		 */
		public Builder addSections(List<IVulnerabilityReportSection> sections) {
			this.sections.addAll(sections);
			return this;
		}

		/**
		 * Builder method of the builder.
		 *
		 * @return built class
		 */
		public VulnerabilityReport build() {
			return new VulnerabilityReport(this);
		}
	}

}
